<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PennyPilot - Take Charge of Your Money</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1ABC9C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PennyPilot">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "var(--color-primary)",
                        danger: "var(--color-danger)",
                        warning: "var(--color-warning)",
                        surface1: "var(--color-surface-1)",
                        surface2: "var(--color-surface-2)",
                        surface3: "var(--color-surface-3)",
                        surface4: "var(--color-surface-4)",
                        textPrimary: "var(--color-text-primary)",
                        textSecondary: "var(--color-text-secondary)",
                        border: "var(--color-border)",
                    },
                    spacing: {
                        0: "0rem",
                        1: "0.25rem",
                        2: "0.5rem",
                        3: "1rem",
                        4: "1.5rem",
                        5: "2rem",
                        6: "3rem",
                    },
                    borderRadius: {
                        sm: "4px",
                        md: "8px",
                        lg: "12px",
                        full: "9999px",
                    },
                    boxShadow: {
                        sm: "0 1px 2px rgba(0,0,0,.05)",
                        md: "0 2px 4px rgba(0,0,0,.10)",
                        lg: "0 4px 8px rgba(0,0,0,.14)",
                    },
                    transitionTimingFunction: {
                        spring: "cubic-bezier(.16,1,.3,1)",
                    },
                    transitionDuration: {
                        fast: "150ms",
                        base: "250ms",
                        slow: "400ms",
                    },
                },
            },
        }
    </script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    :root {
        /* Light mode colors */
        --color-surface-1: #FFFFFF;
        --color-surface-2: #F8FAFB; /* Lighter surface for modern feel */
        --color-surface-3: #E0E0E0;
        --color-surface-4: #C4C4C4;
        --color-primary: #1ABC9C;
        --color-danger: #E74C3C;
        --color-warning: #F39C12;
        --color-text-primary: #222222;
        --color-text-secondary: #4A4A4A;
        --color-border: #E0E0E0;
        --color-focus-ring: #1ABC9C80;
        --space: 8px;
        --money-positive: #059669;
        --money-negative: #DC2626;
        --color-income: var(--money-positive);
        --color-expense: var(--money-negative);
        --color-income-border: var(--color-income);
        --color-expense-border: var(--color-expense);

        /* MODIFIED: CSS Variables for Theming Table and Rows */
        --color-table-header-bg: var(--color-surface-2); /* Header matches card surface */
        --color-surface-1-alt: #FFFFFF; /* Alternate row background for light theme */
        --color-row-border: var(--color-border);
        --color-selected-row-bg: rgba(26, 188, 156, 0.1);
        --shadow-lg: 0 4px 6px rgba(0,0,0,0.1);
    }

    .dark {
        /* Dark mode colors */
        --color-surface-1: #121212;
        --color-surface-2: #1E1E1E;
        --color-surface-3: #2A2A2A;
        --color-surface-4: #383838;
        --color-text-primary: #FAFAFA;
        --color-text-secondary: #C2C2C2;
        --color-border: #333333;
        --money-positive: #34D399;
        --money-negative: #F87171;
        --color-income: var(--money-positive);
        --color-expense: var(--money-negative);
        --color-income-border: var(--color-income);
        --color-expense-border: var(--color-expense);

        /* MODIFIED: Dark Theme CSS Variables for Table and Rows */
        --color-table-header-bg: var(--color-surface-2);
        --color-surface-1-alt: #242424; 
        --color-selected-row-bg: rgba(26, 188, 156, 0.25);
        --shadow-lg: 0 4px 6px rgba(0,0,0,0.4);
    }

    body {
        font-family: 'Inter', ui-sans-serif, system-ui, sans-serif;
        background-color: var(--color-surface-1);
        color: var(--color-text-primary);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: var(--color-surface-2);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--color-border);
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-secondary);
    }

    /* Focus styles */
    .focus-ring:focus-visible {
        outline: 2px solid var(--color-focus-ring);
        outline-offset: 2px;
    }

    /* Animations */
    @keyframes countUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideOut {
        from { opacity: 1; height: var(--h, auto); }
        to { opacity: 0; height: 0; }
    }

    @keyframes slideIn {
        from { opacity: 0; height: 0; }
        to { opacity: 1; height: var(--h, auto); }
    }

    .animate-count-up {
        animation: countUp 0.6s ease-out;
    }

    .animate-slide-in-right {
        animation: slideInRight 0.3s ease-out;
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.4s ease-out;
    }

    /* Toast styles */
    .toast {
        transform: translateY(100px);
        transition: transform 0.3s ease-out;
    }

    .toast.show {
        transform: translateY(0);
    }

    /* FAB animations */
    .fab-expanded {
        transform: rotate(45deg);
    }

    /* FAB base styles */
    .fab-option {
        border: 1px solid transparent;
        transform: translateY(8px);
        transition: transform 0.2s, opacity 0.2s;
    }
    #mainFab {
        border: 1px solid transparent;
    }
    body:not(.dark) .fab-option,
    body:not(.dark) #mainFab {
        border-color: rgba(0,0,0,0.1);
        box-shadow: var(--shadow-lg);
    }

    #fabOptions.show .fab-option {
        transform: translateY(0);
    }
    #fabOptions.show .fab-option:nth-child(2) {
        transition-delay: 150ms;
    }

    /* Card hover effects */
    .card-hover:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
        transition: all 0.2s ease-out;
    }

    .transaction-card:active {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
        transition: all 0.15s ease-out;
    }

    /* Progress circle */
    .progress-circle {
        transform: rotate(-90deg);
    }

    /* Sparkline */
    .sparkline-point {
        transition: all 0.2s ease-out;
    }

    .sparkline-point:hover {
        r: 4;
        fill: var(--color-primary);
    }

    .animate-slide-out {
        animation: slideOut 0.3s ease forwards;
    }

    .animate-slide-in {
        animation: slideIn 0.15s ease forwards;
    }

    .tabular-nums {
        font-variant-numeric: tabular-nums;
    }

    .transaction-checkbox {
        width: 14px;
        height: 14px;
    }

    .text-income { color: var(--color-income); }
    .text-expense { color: var(--color-expense); }

    .theme-overlay {
        pointer-events: none;
        position: fixed;
        inset: 0;
        background: var(--color-surface-1);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 50;
    }

    html.animate-theme {
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    }

    /* --- NEW/MODIFIED CSS FOR TABLE THEMING --- */

    /* Table Header Styling */
    .table-header {
        background-color: var(--color-table-header-bg);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .table-header th {
        border-bottom: 1px solid var(--color-border);
        color: var(--color-text-secondary);
    }

    /* Transaction Row Styling */
    .transactions-row {
        transition: background-color 0.1s ease;
        border-bottom: 1px solid var(--color-row-border);
        line-height: 1.5;
        position: relative;
    }
    .transactions-row:hover {
        background-color: var(--color-surface-1-alt);
    }
    .transactions-row:last-child { 
        border-bottom: none;
    }
    .transactions-row.group:hover {
        background-color: rgba(255,255,255,0.05) !important;
    }

    /* Income and expense row accents */
    .row-income::before,
    .row-expense::before {
        content: '';
        position: absolute;
        left: 0;
        top: 2px;
        bottom: 2px;
        width: 2px;
    }
    .row-income::before { background-color: var(--color-income-border); }
    .row-expense::before { background-color: var(--color-expense-border); }

    .merchant-col {
        max-width: 12rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Class for JS to apply for zebra striping */
    .bg-surface1-alt { /* This class will be applied to odd rows over the table's base background */
        background-color: var(--color-surface-1-alt);
    }
    /* Class for JS to apply for selected rows */
    .bg-selected-row {
        background-color: var(--color-selected-row-bg) !important;
    }

    body.density-compact .transactions-row td {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }


    /* Closing Entry Row Styling */
    .closing-entry-row {
        background-color: var(--color-surface-1-alt);
        border-top: 1px dashed var(--color-border);
        border-bottom: 1px dashed var(--color-border);
        position: sticky;
        top: 0;
        z-index: 1;
        backdrop-filter: blur(4px);
    }
    .closing-entry-row td {
        font-style: italic;
    }
    /* Make date and amount in closing row more prominent */
    .closing-entry-row td.closing-data-emphasis {
        font-weight: 600; /* semibold */
        color: var(--color-text-primary);
    }

    .closing-entry-row td.closing-date {
        color: var(--color-text-secondary);
    }

    .dark .closing-entry-row {
        background-color: var(--color-surface-4);
    }
    
    /* Mobile Closing Entry Card Styling */
    .closing-entry-card {
        background-color: var(--color-surface-3); /* More distinct background */
        border: 1px solid var(--color-border);
        position: sticky;
        top: 0;
        z-index: 1;
        backdrop-filter: blur(4px);
    }
    .dark .closing-entry-card {
        background-color: var(--color-surface-4);
    }
    .closing-entry-card .closing-card-date {
        font-weight: 600; /* semibold */
        color: var(--color-text-primary);
    }
    .closing-entry-card .closing-card-amount {
        font-weight: 600; /* semibold */
        color: var(--color-text-primary);
    }


    /* --- END OF NEW/MODIFIED CSS --- */

    .page {
        display: none;
    }
    .page.active {
        display: block;
    }
    .nav-item {
        color: var(--color-text-secondary);
        transition: all 0.2s ease;
    }
    .nav-item:hover {
        color: var(--color-text-primary);
        background-color: var(--color-surface-3);
    }
    .nav-item.active {
        color: var(--color-primary);
        background-color: rgba(26, 188, 156, 0.1); 
    }
    .mobile-nav.active {
        color: var(--color-primary);
    }
    .filter-pill {
        padding: calc(var(--space)/2) var(--space);
        border: 1px solid var(--color-border);
        border-radius: 9999px;
        background: var(--color-surface-1);
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    .filter-pill:hover {
        background: var(--color-surface-3);
    }
    .filter-pill.active:not([data-filter="all"]) {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }
    .date-filter-btn {
        padding: calc(var(--space)/2) var(--space);
        border: 1px solid var(--color-border);
        border-radius: 0.5rem;
        background: var(--color-surface-1);
        color: var(--color-text-secondary);
        font-size: 0.875rem;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    .date-filter-btn:hover {
        background: var(--color-surface-3);
    }
    .date-filter-btn.active:not([data-range="all"]) {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }
    .date-toggle-btn {
        min-width: 4.5rem;
        white-space: nowrap;
    }
    .segmented-control {
        display: flex;
        border: 1px solid var(--color-border);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .segmented-control .filter-pill {
        border-radius: 0;
        border: none;
        border-right: 1px solid var(--color-border);
    }
    .segmented-control .filter-pill:last-child {
        border-right: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .budget-slider {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: var(--color-surface-3);
        border-radius: 3px;
        outline: none;
    }
    .budget-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: var(--color-primary);
        border-radius: 50%;
        cursor: pointer;
    }
    .budget-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: var(--color-primary);
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    .row-chrome button {
        transition: opacity 0.15s, transform 0.1s;
    }
    .row-chrome button:hover {
        transform: scale(1.1);
    }
    .skeleton {
        background: rgba(26,188,156,0.1); 
        border-radius: 4px;
        animation: pulse 1.5s infinite ease-in-out;
    }
    @keyframes pulse {
        0%,100% { opacity: 0.3; }
        50% { opacity: 0.6; }
    }
    #bulkDeleteBtn {
        transition: transform 0.2s, opacity 0.2s;
    }
</style>
</head>
<body class="h-full bg-surface1 text-textPrimary">
    <div id="app" class="h-full flex flex-col">
        <!-- Top Navigation (Desktop) -->
        <nav class="hidden lg:flex bg-surface2 border-b border-border px-6 py-4 shadow-sm">
            <div class="flex items-center justify-between w-full max-w-7xl mx-auto">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-coins text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-bold text-textPrimary">PennyPilot</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="focus-ring p-2 rounded-md hover:bg-surface3 transition-colors">
                        <i class="fas fa-moon text-textSecondary"></i>
                    </button>
                    <div class="text-sm text-textSecondary">
                        <span id="currentDate"></span>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Mobile Header -->
        <header class="lg:hidden bg-surface2 border-b border-border px-4 py-3 shadow-sm">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="w-6 h-6 bg-primary rounded flex items-center justify-center">
                        <i class="fas fa-coins text-white text-xs"></i>
                    </div>
                    <h1 class="text-lg font-bold text-textPrimary">PennyPilot</h1>
                </div>
                
                <button id="mobileThemeToggle" class="focus-ring p-2 rounded-md hover:bg-surface3 transition-colors">
                    <i class="fas fa-moon text-textSecondary"></i>
                </button>
            </div>
        </header>
        
        <div class="flex flex-1 overflow-hidden">
            <!-- Desktop Sidebar -->
            <aside class="hidden lg:flex w-56 xl:w-64 bg-surface2 border-r border-border flex-col">
                <nav class="flex-1 px-4 py-4 space-y-2">
                    <a href="#" class="nav-item active flex items-center px-3 py-2 rounded-md text-sm font-medium" data-page="dashboard">
                        <i class="fas fa-home mr-3 w-4"></i>
                        Dashboard
                    </a>
                    <a href="#" class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium" data-page="transactions">
                        <i class="fas fa-exchange-alt mr-3 w-4"></i>
                        Transactions
                    </a>
                    <a href="#" class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium" data-page="budgets">
                        <i class="fas fa-chart-pie mr-3 w-4"></i>
                        Budgets
                    </a>
                    <a href="#" class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium" data-page="reports">
                        <i class="fas fa-chart-line mr-3 w-4"></i>
                        Reports
                    </a>
                    <a href="#" class="nav-item flex items-center px-3 py-2 rounded-md text-sm font-medium" data-page="settings">
                        <i class="fas fa-cog mr-3 w-4"></i>
                        Settings
                    </a>
                </nav>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1 overflow-auto bg-surface1">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-20 lg:pb-6">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page active">
                        <div class="mb-6">
                            <h2 class="text-2xl sm:text-3xl font-bold text-textPrimary mb-2">Dashboard</h2>
                            <p class="text-textSecondary">Your financial overview at a glance</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <!-- Balance Card -->
                            <div class="lg:col-span-2 bg-surface2 rounded-lg p-6 shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-semibold text-textPrimary">Current Balance</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-textSecondary" id="balanceDate">This Week</span>
                                        <button class="text-textSecondary hover:text-textPrimary transition-colors">
                                            <i class="fas fa-refresh text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <div class="space-y-1 text-sm">
                                        <div class="flex items-center justify-between">
                                            <span class="text-textSecondary">Opening (Tue)</span>
                                            <span class="font-medium" id="openingBalance"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-textSecondary">+ Income</span>
                                            <span class="font-medium text-income" id="weeklyIncome"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-textSecondary">&minus; Expenses</span>
                                            <span class="font-medium text-expense" id="weeklyExpenses"></span>
                                        </div>
                                    </div>

                                    <div class="text-4xl font-bold text-textPrimary mt-3 animate-count-up" id="currentBalance">
                                        $2,847.50
                                    </div>
                                </div>
                                
                                <!-- Balance Sparkline -->
                                <div class="h-16">
                                    <svg id="balanceSparkline" class="w-full h-full" viewBox="0 0 300 60">
                                        <!-- Sparkline will be drawn here -->
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Budget Compass -->
                            <div class="bg-surface2 rounded-lg p-6 shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-textPrimary">Budget Status</h3>
                                    <button class="text-textSecondary hover:text-textPrimary transition-colors">
                                        <i class="fas fa-info-circle text-sm"></i>
                                    </button>
                                </div>
                                
                                <div class="flex items-center justify-center mb-4">
                                    <div class="relative w-32 h-32">
                                        <svg class="w-full h-full progress-circle" viewBox="0 0 120 120">
                                            <circle cx="60" cy="60" r="50" fill="none" stroke="var(--color-surface-3)" stroke-width="8"/>
                                            <circle id="budgetProgressCircle" cx="60" cy="60" r="50" fill="none" stroke="var(--color-primary)" stroke-width="8" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="235"/>
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <div class="text-center">
                                                <div class="text-2xl font-bold text-textPrimary" id="budgetPercentage"></div>
                                                <div class="text-xs text-textSecondary">Used</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="text-sm text-textSecondary mb-1">Weekly Budget</div>
                                    <div class="text-lg font-semibold text-textPrimary" id="weeklyBudget"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Transactions -->
                        <div class="bg-surface2 rounded-lg p-6 shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-textPrimary">Recent Transactions</h3>
                                <button class="text-primary hover:text-primary/80 transition-colors text-sm font-medium flex items-center" onclick="showPage('transactions')">
                                    View All
                                    <i class="fas fa-arrow-right ml-1 text-xs"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-3" id="recentTransactions">
                                <!-- Recent transactions will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transactions Page -->
                    <div id="transactions-page" class="page">
                        <div class="mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl sm:text-3xl font-bold text-textPrimary mb-2">Transactions</h2>
                                    <p class="text-textSecondary">Manage your income and expenses</p>
                                </div>
                                <button id="bulkDeleteBtn" class="hidden opacity-0 translate-y-2 bg-danger text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-danger/90 transition-colors">
                                    <i class="fas fa-trash mr-2"></i>
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search and Filters -->
                        <div class="bg-surface2 rounded-lg p-4 mb-6 shadow-md">
                        <div class="flex flex-col lg:flex-row lg:items-center gap-4">
                                <div class="flex-1 relative">
                                    <input type="text" id="transactionSearch" placeholder="Search transactions..."
                                           class="focus-ring w-full pl-10 pr-4 py-2 border border-border rounded-md bg-surface1 text-textPrimary text-base shadow-inner focus:border-primary transition-colors">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-textSecondary pointer-events-none"></i>
                                </div>

                                <!-- Desktop Toolbar -->
                                <div class="hidden lg:flex items-center gap-2 flex-shrink-0">
                                    <div class="relative">
                                        <button id="categoryDropdownBtn" class="date-toggle-btn date-filter-btn">Category ▾</button>
                                        <div id="categoryDropdownMenu" class="hidden absolute left-0 mt-2 w-36 bg-surface1 border border-border rounded-md shadow-lg p-2 space-y-2 z-20">
                                            <button class="filter-pill w-full text-left active" data-filter="all">All</button>
                                            <button class="filter-pill w-full text-left" data-filter="income">Income</button>
                                            <button class="filter-pill w-full text-left" data-filter="expense">Expense</button>
                                            <button class="filter-pill w-full text-left" data-filter="food">Food</button>
                                            <button class="filter-pill w-full text-left" data-filter="transport">Transport</button>
                                            <button class="filter-pill w-full text-left" data-filter="entertainment">Entertainment</button>
                                        </div>
                                    </div>
                                    <div class="relative">
                                        <button id="dateDropdownBtn" class="date-toggle-btn date-filter-btn">Date Range ▾</button>
                                        <div id="dateDropdownMenu" class="hidden absolute left-0 mt-2 w-36 bg-surface1 border border-border rounded-md shadow-lg p-2 space-y-2 z-20">
                                            <button class="date-filter-btn w-full text-left active" data-range="all">All Time</button>
                                            <button class="date-filter-btn w-full text-left" data-range="today">Today</button>
                                            <button class="date-filter-btn w-full text-left" data-range="week">This Week</button>
                                            <button class="date-filter-btn w-full text-left" data-range="month">This Month</button>
                                            <button class="date-filter-btn w-full text-left" data-range="lastMonth">Last Month</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mobile Filters -->
                            <div class="lg:hidden mt-4 space-y-3">
                                <div class="relative">
                                    <button id="categoryDropdownBtnMobile" class="w-full date-toggle-btn date-filter-btn">Category ▾</button>
                                    <div id="categoryDropdownMenuMobile" class="hidden absolute left-0 mt-2 w-44 bg-surface1 border border-border rounded-md shadow-lg p-2 space-y-2 z-20">
                                        <button class="filter-pill w-full text-left active" data-filter="all">All</button>
                                        <button class="filter-pill w-full text-left" data-filter="income">Income</button>
                                        <button class="filter-pill w-full text-left" data-filter="expense">Expense</button>
                                        <button class="filter-pill w-full text-left" data-filter="food">Food</button>
                                        <button class="filter-pill w-full text-left" data-filter="transport">Transport</button>
                                        <button class="filter-pill w-full text-left" data-filter="entertainment">Entertainment</button>
                                    </div>
                                </div>
                                <div class="relative">
                                    <button id="dateDropdownBtnMobile" class="w-full date-toggle-btn date-filter-btn">Date Range ▾</button>
                                    <div id="dateDropdownMenuMobile" class="hidden absolute left-0 mt-2 w-44 bg-surface1 border border-border rounded-md shadow-lg p-2 space-y-2 z-20">
                                        <button class="date-filter-btn w-full text-left active" data-range="all">All Time</button>
                                        <button class="date-filter-btn w-full text-left" data-range="today">Today</button>
                                        <button class="date-filter-btn w-full text-left" data-range="week">This Week</button>
                                        <button class="date-filter-btn w-full text-left" data-range="month">This Month</button>
                                        <button class="date-filter-btn w-full text-left" data-range="lastMonth">Last Month</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Desktop Table View -->
                        <div class="hidden lg:block bg-surface2 rounded-lg overflow-hidden p-2">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="table-header sticky top-0 z-10">
                                        <tr>
                                            <th class="w-10 px-3 py-4 text-center text-sm font-semibold text-textSecondary uppercase tracking-wider">
                                                <input type="checkbox" id="selectAllTransactions" class="transaction-checkbox focus-ring rounded border-border">
                                            </th>
                                            <th class="w-32 px-6 py-4 text-left text-sm font-semibold text-textSecondary uppercase tracking-wider cursor-pointer select-none" data-sort="date" aria-sort="none">
                                                <span class="inline-flex items-center">
                                                    Date
                                                    <i class="fas fa-chevron-down ml-1 text-xs transition-transform opacity-0"></i>
                                                </span>
                                            </th>
                                            <th class="w-40 px-6 py-4 text-left text-sm font-semibold text-textSecondary uppercase tracking-wider cursor-pointer select-none" data-sort="merchant" aria-sort="none">
                                                <span class="inline-flex items-center">
                                                    Merchant
                                                    <i class="fas fa-chevron-down ml-1 text-xs transition-transform opacity-0"></i>
                                                </span>
                                            </th>
                                            <th class="w-40 px-6 py-4 text-left text-sm font-semibold text-textSecondary uppercase tracking-wider">Category</th>
                                            <th class="w-32 px-6 py-4 text-right text-sm font-semibold text-textSecondary uppercase tracking-wider cursor-pointer select-none" data-sort="amount" aria-sort="none">
                                                <span class="inline-flex items-center">
                                                    Amount
                                                    <i class="fas fa-chevron-down ml-1 text-xs transition-transform opacity-0"></i>
                                                </span>
                                            </th>
                                            <th class="w-12 px-6 py-4 text-left text-sm font-semibold text-textSecondary uppercase tracking-wider">
                                                <span class="sr-only">Actions</span>
                                                <i class="fas fa-ellipsis-h" title="Actions"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTableBody" class="">
                                        <!-- Transaction rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Mobile Card View -->
                        <div class="lg:hidden space-y-4" id="transactionCards">
                            <!-- Transaction cards will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Budgets Page -->
                    <div id="budgets-page" class="page">
                        <div class="mb-6">
                            <h2 class="text-2xl sm:text-3xl font-bold text-textPrimary mb-2">Budgets</h2>
                            <p class="text-textSecondary">Track your spending by category</p>
                        </div>
                        
                        <!-- Pinned Budgets -->
                        <div id="pinnedBudgets" class="mb-8">
                            <h3 class="text-lg font-semibold text-textPrimary mb-4">📌 Pinned Budgets</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="pinnedBudgetCards">
                                <!-- Pinned budget cards will be populated here -->
                            </div>
                        </div>
                        
                        <!-- All Budgets -->
                        <div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="budgetCards">
                                <!-- Budget cards will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports Page -->
                    <div id="reports-page" class="page">
                        <div class="mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl sm:text-3xl font-bold text-textPrimary mb-2">Reports</h2>
                                    <p class="text-textSecondary">Analyze your financial trends</p>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <button class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90 transition-colors">
                                        <i class="fas fa-file-pdf mr-2"></i>
                                        Export PDF
                                    </button>
                                    <button class="bg-surface3 text-textPrimary px-4 py-2 rounded-md text-sm font-medium hover:bg-surface3/80 transition-colors">
                                        <i class="fas fa-file-csv mr-2"></i>
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <!-- Spending Overview -->
                            <div class="bg-surface2 rounded-lg p-6 shadow-md">
                                <h3 class="text-lg font-semibold text-textPrimary mb-4">Spending Overview</h3>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="spendingChart" width="300" height="300"></canvas>
                                </div>
                            </div>
                            
                            <!-- Income vs Expense Trends -->
                            <div class="bg-surface2 rounded-lg p-6 shadow-md">
                                <h3 class="text-lg font-semibold text-textPrimary mb-4">Income vs Expense Trends</h3>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="trendsChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Budget Variance Table -->
                        <div class="bg-surface2 rounded-lg p-6 shadow-md mt-6">
                            <h3 class="text-lg font-semibold text-textPrimary mb-4">Budget Variance</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-border">
                                            <th class="text-left py-3 text-sm font-medium text-textSecondary">Category</th>
                                            <th class="text-right py-3 text-sm font-medium text-textSecondary">Budgeted</th>
                                            <th class="text-right py-3 text-sm font-medium text-textSecondary">Actual</th>
                                            <th class="text-right py-3 text-sm font-medium text-textSecondary">Variance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="varianceTableBody">
                                        <!-- Variance rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Page -->
                    <div id="settings-page" class="page">
                        <div class="mb-6">
                            <h2 class="text-2xl sm:text-3xl font-bold text-textPrimary mb-2">Settings</h2>
                            <p class="text-textSecondary">Customize your PennyPilot experience</p>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- General Preferences -->
                            <details class="group bg-surface2 rounded-lg shadow-md overflow-hidden">
  <!-- Summary becomes the clickable header -->
  <summary class="flex items-center justify-between px-6 py-4 cursor-pointer select-none">
    <h3 class="text-lg font-semibold text-textPrimary">General Preferences</h3>
    <!-- A little arrow that rotates when open -->
    <svg
      class="w-5 h-5 text-textSecondary transition-transform duration-200 ease-in-out group-open:rotate-180"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 9l-7 7-7-7" />
    </svg>
  </summary>

  <!-- Hidden by default; shown when <details> is open -->
  <div class="px-6 pb-6 space-y-4">
    <!-- Date Format Dropdown -->
    <div>
      <label for="dateFormatSelect" class="block text-sm font-medium text-textPrimary mb-2">
        Date Format
      </label>
      <select
        id="dateFormatSelect"
        name="dateFormat"
        class="focus-ring block w-full max-w-xs px-3 py-2 border border-border rounded-md bg-surface1 text-textPrimary text-base focus:border-primary transition-colors"
        required
      >
        <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
      </select>
    </div>

    <!-- Currency Dropdown -->
    <div>
      <label for="currencySelect" class="block text-sm font-medium text-textPrimary mb-2">
        Currency
      </label>
      <select
        id="currencySelect"
        name="currency"
        class="focus-ring block w-full max-w-xs px-3 py-2 border border-border rounded-md bg-surface1 text-textPrimary text-base focus:border-primary transition-colors"
        required
      >
        <option value="NZD">NZD</option>
        <option value="USD">USD</option>
        <option value="AUD">AUD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
      </select>
    </div>

    <!-- Theme Dropdown -->
    <div>
      <label for="themeSelect" class="block text-sm font-medium text-textPrimary mb-2">
        Theme
      </label>
      <select
        id="themeSelect"
        name="theme"
        class="focus-ring block w-full max-w-xs px-3 py-2 border border-border rounded-md bg-surface1 text-textPrimary text-base focus:border-primary transition-colors"
        required
      >
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="system" selected>System</option>
      </select>
    </div>

    <!-- Density Dropdown -->
    <div>
      <label for="densitySelect" class="block text-sm font-medium text-textPrimary mb-2">
        Density
      </label>
      <select
        id="densitySelect"
        name="density"
        class="focus-ring block w-full max-w-xs px-3 py-2 border border-border rounded-md bg-surface1 text-textPrimary text-base focus:border-primary transition-colors"
        required
      >
        <option value="comfy" selected>Comfy</option>
        <option value="compact">Compact</option>
      </select>
    </div>
  </div>
</details>
                            
                            <!-- Category Management -->
                            <details class="group bg-surface2 rounded-lg shadow-md overflow-hidden">
  <summary class="flex items-center justify-between px-6 py-4 cursor-pointer select-none">
    <h3 class="text-lg font-semibold text-textPrimary">Categories</h3>
    <svg
      class="w-5 h-5 text-textSecondary transition-transform duration-200 ease-in-out"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 9l-7 7-7-7" />
    </svg>
  </summary>

  <div id="categoriesListContainer" class="px-6 pb-6 space-y-3">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-textPrimary">Categories</h3>
      <button id="addCategoryBtn" class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90 transition-colors">
        <i class="fas fa-plus mr-2"></i>
        Add Category
      </button>
    </div>
    <div class="space-y-3" id="categoriesList">
      <!-- Categories will be populated here -->
    </div>
  </div>
</details>

                            
                            <!-- Data Management -->
                            <details class="group bg-surface2 rounded-lg shadow-md overflow-hidden">
  <summary class="flex items-center justify-between px-6 py-4 cursor-pointer select-none">
    <h3 class="text-lg font-semibold text-textPrimary">Data Management</h3>
    <svg
      class="w-5 h-5 text-textSecondary transition-transform duration-200 ease-in-out"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 9l-7 7-7-7" />
    </svg>
  </summary>

  <div class="px-6 pb-6 space-y-4">
    <div>
      <h4 class="text-sm font-medium text-textPrimary mb-2">Backup & Restore</h4>
      <div class="flex flex-wrap gap-3">
        <button id="downloadBackupBtn" class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90 transition-colors">
          <i class="fas fa-download mr-2"></i>
          Download Backup
        </button>
        <label for="uploadBackup" class="bg-surface3 text-textPrimary px-4 py-2 rounded-md text-sm font-medium hover:bg-surface3/80 transition-colors cursor-pointer">
          <i class="fas fa-upload mr-2"></i>
          Upload Backup
        </label>
        <input type="file" id="uploadBackup" accept=".json" class="hidden">
      </div>
    </div>

    <div>
      <h4 class="text-sm font-medium text-textPrimary mb-2">Reset Data</h4>
      <button id="resetDataBtn" class="bg-danger text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-danger/90 transition-colors">
        <i class="fas fa-trash mr-2"></i>
        Reset All Data
      </button>
      <p class="text-xs text-textSecondary mt-1">
        This will permanently delete all your transactions, budgets, and settings.
      </p>
    </div>
  </div>
</details>

                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-surface2 border-t border-border z-40">
            <div class="flex items-center justify-around py-2">
                <a href="#" class="nav-item mobile-nav active flex flex-col items-center py-3 px-2 text-xs" data-page="dashboard">
                    <i class="fas fa-home text-lg mb-1"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item mobile-nav flex flex-col items-center py-3 px-2 text-xs" data-page="transactions">
                    <i class="fas fa-exchange-alt text-lg mb-1"></i>
                    <span>Transactions</span>
                </a>
                <a href="#" class="nav-item mobile-nav flex flex-col items-center py-3 px-2 text-xs" data-page="budgets">
                    <i class="fas fa-chart-pie text-lg mb-1"></i>
                    <span>Budgets</span>
                </a>
                <a href="#" class="nav-item mobile-nav flex flex-col items-center py-3 px-2 text-xs" data-page="reports">
                    <i class="fas fa-chart-line text-lg mb-1"></i>
                    <span>Reports</span>
                </a>
                <a href="#" class="nav-item mobile-nav flex flex-col items-center py-3 px-2 text-xs" data-page="settings">
                    <i class="fas fa-cog text-lg mb-1"></i>
                    <span>Settings</span>
                </a>
            </div>
        </nav>
        
        <!-- Floating Action Button -->
        <div class="fixed bottom-20 lg:bottom-6 right-6 z-50">
            <div id="fabContainer" class="relative">
                <!-- Expanded Options -->
                <div id="fabOptions" class="absolute bottom-16 right-0 space-y-3 opacity-0 transform scale-0 transition-all duration-base ease-spring">
                    <button id="addIncomeBtn" class="fab-option bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-fast">
                        <i class="fas fa-plus text-lg"></i>
                        <span class="sr-only">Add Income</span>
                    </button>
                    <button id="addExpenseBtn" class="fab-option bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-fast">
                        <i class="fas fa-minus text-lg"></i>
                        <span class="sr-only">Add Expense</span>
                    </button>
                </div>
                
                <!-- Main FAB -->
                <button id="mainFab" class="bg-emerald-400 hover:bg-emerald-500 text-white w-14 h-14 rounded-full shadow-lg drop-shadow-md flex items-center justify-center transition-all duration-base focus-ring">
                    <i class="fas fa-plus text-xl transition-transform duration-base"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-surface1 rounded-lg shadow-lg max-w-sm sm:max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="transactionModalTitle" class="text-lg font-semibold text-textPrimary">Add Transaction</h3>
                    <button id="closeTransactionModal" class="text-textSecondary hover:text-textPrimary transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <form id="transactionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-textPrimary mb-1">Type</label>
                        <div class="flex gap-3">
                            <label class="flex items-center">
                                <input type="radio" name="type" value="income" class="focus-ring text-primary">
                                <span class="ml-2 text-sm text-textSecondary">Income</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="type" value="expense" class="focus-ring text-primary" checked>
                                <span class="ml-2 text-sm text-textSecondary">Expense</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label for="transactionDate" class="block text-sm font-medium text-textPrimary mb-1">Date</label>
                        <input type="date" id="transactionDate" class="focus-ring w-full px-3 py-2 border border-border rounded-md bg-surface2 text-textPrimary text-base focus:border-primary transition-colors" required>
                    </div>
                    
                    <div>
                        <label for="transactionMerchant" class="block text-sm font-medium text-textPrimary mb-1">Merchant</label>
                        <input type="text" id="transactionMerchant" placeholder="e.g., Supermarket, Coffee Shop" class="focus-ring w-full px-3 py-2 border border-border rounded-md bg-surface2 text-textPrimary text-base focus:border-primary transition-colors" required>
                    </div>
                    
                    <div>
                        <label for="transactionCategory" class="block text-sm font-medium text-textPrimary mb-1">Category</label>
                        <select id="transactionCategory" class="focus-ring w-full px-3 py-2 border border-border rounded-md bg-surface2 text-textPrimary text-base focus:border-primary transition-colors" required>
                            <option value="">Select a category</option>
                            <option value="food">Food & Dining</option>
                            <option value="transport">Transport</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="housing">Housing</option>
                            <option value="shopping">Shopping</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="health">Health & Medical</option>
                            <option value="education">Education</option>
                            <option value="travel">Travel</option>
                            <option value="salary">Salary</option>
                            <option value="freelance">Freelance</option>
                            <option value="investment">Investment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="transactionAmount" class="block text-sm font-medium text-textPrimary mb-1">Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-textSecondary">$</span>
                            <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" min="0" class="focus-ring w-full pl-8 pr-3 py-2 border border-border rounded-md bg-surface2 text-textPrimary text-base focus:border-primary transition-colors" required>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="cancelTransaction" class="flex-1 bg-surface3 text-textPrimary py-2 rounded-md text-sm font-medium hover:bg-surface3/80 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-md text-sm font-medium hover:bg-primary/90 transition-colors">
                            Save Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-surface1 rounded-lg shadow-lg max-w-sm w-full">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-danger/10 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-textPrimary">Confirm Delete</h3>
                </div>
                
                <p id="deleteModalText" class="text-textSecondary mb-6">Are you sure you want to delete this transaction? This action cannot be undone.</p>
                
                <div class="flex gap-3">
                    <button id="cancelDelete" class="flex-1 bg-surface3 text-textPrimary py-2 rounded-md text-sm font-medium hover:bg-surface3/80 transition-colors">
                        Cancel
                    </button>
                    <button id="confirmDelete" class="flex-1 bg-danger text-white py-2 rounded-md text-sm font-medium hover:bg-danger/90 transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 space-y-2">
        <!-- Toasts will be dynamically added here -->
    </div>

    <script>
        // App State
        let appState = {
            currentPage: 'dashboard',
            transactions: [],
            budgets: [],
            categories: [
                { id: 'food', name: 'Food & Dining', icon: '🍽️', color: '#F78C6B' },
                { id: 'transport', name: 'Transport', icon: '🚗', color: '#6ee7b7' },
                { id: 'housing', name: 'Housing', icon: '🏠', color: '#7C3AED' },
                { id: 'entertainment', name: 'Entertainment', icon: '🎬', color: '#fda4af' },
                { id: 'shopping', name: 'Shopping', icon: '🛍️', color: '#fcd34d' },
                { id: 'bills', name: 'Bills & Utilities', icon: '📄', color: '#f9a8d4' },
                { id: 'health', name: 'Health & Medical', icon: '🏥', color: '#fbcfe8' },
                { id: 'education', name: 'Education', icon: '📚', color: '#93c5fd' },
                { id: 'travel', name: 'Travel', icon: '✈️', color: '#a5b4fc' },
                { id: 'salary', name: 'Salary', icon: '💰', color: '#2DD4BF' },
                { id: 'freelance', name: 'Freelance', icon: '💼', color: '#2DD4BF' },
                { id: 'investment', name: 'Investment', icon: '📈', color: '#99f6e4' },
                { id: 'other', name: 'Other', icon: '🔄', color: '#cbd5e1' }
            ],
            settings: {
                currency: 'NZD',
                dateFormat: 'DD/MM/YYYY',
                theme: 'system',
                density: 'comfy'
            },
            fabExpanded: false,
            selectedTransactions: new Set(),
            editingTransaction: null,
            collapsedDays: {},
            sortField: 'date',
            sortDirection: 'desc',
            loadingTransactions: false,
            transactionsLoaded: false
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            setupEventListeners();
            setupTheme();
            applyDensity();
            renderCurrentPage();
            updateCurrentDate();
        }

        function loadData() {
            // Load from localStorage
            const savedTransactions = localStorage.getItem('pennyPilot_transactions');
            const savedBudgets = localStorage.getItem('pennyPilot_budgets');
            const savedSettings = localStorage.getItem('pennyPilot_settings');
            
            if (savedTransactions) {
                appState.transactions = JSON.parse(savedTransactions);
            }
            
            if (savedBudgets) {
                appState.budgets = JSON.parse(savedBudgets);
            }
            
            if (savedSettings) {
                appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
            }
        }

        function saveData() {
            localStorage.setItem('pennyPilot_transactions', JSON.stringify(appState.transactions));
            localStorage.setItem('pennyPilot_budgets', JSON.stringify(appState.budgets));
            localStorage.setItem('pennyPilot_settings', JSON.stringify(appState.settings));
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    showPage(page);
                });
            });

            // FAB
            document.getElementById('mainFab').addEventListener('click', toggleFab);
            document.getElementById('addIncomeBtn').addEventListener('click', () => openTransactionModal('income'));
            document.getElementById('addExpenseBtn').addEventListener('click', () => openTransactionModal('expense'));

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('mobileThemeToggle').addEventListener('click', toggleTheme);

            // Transaction modal
            document.getElementById('closeTransactionModal').addEventListener('click', closeTransactionModal);
            document.getElementById('cancelTransaction').addEventListener('click', closeTransactionModal);
            document.getElementById('transactionForm').addEventListener('submit', saveTransaction);

            // Delete modal
            document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
            document.getElementById('confirmDelete').addEventListener('click', confirmDelete);

            // Search and filters
            document.getElementById('transactionSearch').addEventListener('input', filterTransactions);
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    updateCategoryDropdownLabel();
                    filterTransactions();
                    document.getElementById('categoryDropdownMenu')?.classList.add('hidden');
                    document.getElementById('categoryDropdownMenuMobile')?.classList.add('hidden');
                    // document.getElementById('dateDropdownMenuMobile')?.classList.add('hidden'); // This was causing date dropdown to close prematurely
                });
            });

            const dateMenus = [
                {btn: document.getElementById('dateDropdownBtn'), menu: document.getElementById('dateDropdownMenu')},
                {btn: document.getElementById('dateDropdownBtnMobile'), menu: document.getElementById('dateDropdownMenuMobile')}
            ];

            dateMenus.forEach(({btn, menu}) => {
                if (!btn || !menu) return;
                btn.addEventListener('click', () => menu.classList.toggle('hidden'));
                document.addEventListener('click', (e) => {
                    if (menu && !menu.contains(e.target) && btn && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                });
            });

            const categoryMenus = [
                {btn: document.getElementById('categoryDropdownBtn'), menu: document.getElementById('categoryDropdownMenu')},
                {btn: document.getElementById('categoryDropdownBtnMobile'), menu: document.getElementById('categoryDropdownMenuMobile')}
            ];

            categoryMenus.forEach(({btn, menu}) => {
                if (!btn || !menu) return;
                btn.addEventListener('click', () => menu.classList.toggle('hidden'));
                document.addEventListener('click', (e) => {
                     if (menu && !menu.contains(e.target) && btn && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                });
            });

            document.querySelectorAll('.date-filter-btn[data-range]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Deselect other buttons within the same dropdown
                    const parentDropdown = e.target.closest('div[id$="DropdownMenu"], div[id$="DropdownMenuMobile"]');
                    if (parentDropdown) {
                         parentDropdown.querySelectorAll('.date-filter-btn[data-range]').forEach(b => b.classList.remove('active'));
                    } else { // For non-dropdown buttons if any, or global deselection (less common)
                         document.querySelectorAll('.date-filter-btn[data-range]').forEach(b => b.classList.remove('active'));
                    }


                    e.target.classList.add('active');
                    updateDateDropdownLabel();
                    dateMenus.forEach(({menu}) => menu?.classList.add('hidden'));
                    filterTransactions();
                });
            });

            // Select all transactions
            document.getElementById('selectAllTransactions').addEventListener('change', toggleSelectAll);

            // Sorting
            document.querySelectorAll('[data-sort]').forEach(th => {
                th.addEventListener('click', () => setSort(th.dataset.sort));
            });

            // Close modals on outside click
            document.getElementById('transactionModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeTransactionModal();
            });

            document.getElementById('deleteModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeDeleteModal();
            });

            // Settings
            setupSettingsEventListeners();

            updateCategoryDropdownLabel();
            updateDateDropdownLabel();
        }

        function setupSettingsEventListeners() {
    // Currency change
    document.getElementById('currencySelect').addEventListener('change', (e) => {
        appState.settings.currency = e.target.value;
        saveData();
        updateCurrencyDisplay();
    });

    // Theme change - Updated for <select>
    document.getElementById('themeSelect').addEventListener('change', (e) => {
        appState.settings.theme = e.target.value;
        saveData();
        applyTheme();
    });

    document.getElementById('densitySelect').addEventListener('change', (e) => {
        appState.settings.density = e.target.value;
        saveData();
        applyDensity();
    });

    // Date format change - Updated for <select>
    document.getElementById('dateFormatSelect').addEventListener('change', (e) => {
        appState.settings.dateFormat = e.target.value;
        saveData();
        renderCurrentPage(); // This will re-render settings, including date formats in transactions
    });

    // Data management
    document.getElementById('downloadBackupBtn').addEventListener('click', downloadBackup);
    document.getElementById('uploadBackup').addEventListener('change', uploadBackup);
    document.getElementById('resetDataBtn').addEventListener('click', resetData);
}

        function setupTheme() {
            applyTheme();
        }

        function applyTheme() {
            const theme = appState.settings.theme;
            const html = document.documentElement;
            
            if (theme === 'dark') {
                html.classList.add('dark');
            } else if (theme === 'light') {
                html.classList.remove('dark');
            } else {
                // System theme
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
            }
            
            updateThemeIcons();
        }

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const icon = isDark ? 'fa-sun' : 'fa-moon';
            
            document.querySelectorAll('#themeToggle i, #mobileThemeToggle i').forEach(i => {
                i.className = `fas ${icon}`;
            });
        }

        function applyDensity() {
            const body = document.body;
            if (appState.settings.density === 'compact') {
                body.classList.add('density-compact');
            } else {
                body.classList.remove('density-compact');
            }
        }

        function toggleTheme() {
    const currentTheme = appState.settings.theme;
    let newTheme;

    if (currentTheme === 'light') {
        newTheme = 'dark';
    } else if (currentTheme === 'dark') {
        newTheme = 'system';
    } else {
        newTheme = 'light';
    }

    appState.settings.theme = newTheme;
    saveData();
    applyTheme();

    document.documentElement.classList.add('animate-theme');
    const overlay = document.createElement('div');
    overlay.className = 'theme-overlay';
    document.body.appendChild(overlay);
    requestAnimationFrame(() => {
        overlay.style.opacity = '1';
        requestAnimationFrame(() => {
            overlay.style.opacity = '0';
        });
    });
    overlay.addEventListener('transitionend', () => overlay.remove(), { once: true });
    setTimeout(() => document.documentElement.classList.remove('animate-theme'), 200);

    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
        themeSelect.value = newTheme;
    }
}

        function showPage(pageName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show target page
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
                appState.currentPage = pageName;
                renderCurrentPage();
            }

            // Close FAB if expanded
            if (appState.fabExpanded) {
                toggleFab();
            }
        }

        function renderCurrentPage() {
            switch (appState.currentPage) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'transactions':
                    if (!appState.transactionsLoaded) {
                        appState.loadingTransactions = true;
                        renderTransactions();
                        setTimeout(() => {
                            appState.loadingTransactions = false;
                            appState.transactionsLoaded = true;
                            renderTransactions();
                        }, 600);
                    } else {
                        renderTransactions();
                    }
                    break;
                case 'budgets':
                    renderBudgets();
                    break;
                case 'reports':
                    renderReports();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }
        }

        function renderDashboard() {
            // Weekly stats for income/expenses
            const weeklyStats = calculateWeeklyStats();

            // Calculate closing balance for today
            const todayBalance = calculateClosingBalanceToday();
            updateBalanceDateToday();
            
            // Update balance card
            document.getElementById('currentBalance').textContent = formatCurrency(todayBalance);
            document.getElementById('weeklyIncome').textContent = formatCurrency(weeklyStats.income);
            document.getElementById('weeklyExpenses').textContent = formatCurrency(weeklyStats.expenses);
            const openingBalance = todayBalance - (weeklyStats.income - weeklyStats.expenses);
            document.getElementById('openingBalance').textContent = formatCurrency(openingBalance);
            
            // Animate balance
            const balanceEl = document.getElementById('currentBalance');
            balanceEl.classList.remove('animate-count-up');
            setTimeout(() => balanceEl.classList.add('animate-count-up'), 10);
            
            // Update budget compass
            updateBudgetCompass();
            
            // Render sparkline
            renderBalanceSparkline();
            
            // Render recent transactions
            renderRecentTransactions();
        }

        function calculateBalance() {
            return appState.transactions.reduce((sum, t) => {
                return sum + (t.type === 'income' ? t.amount : -t.amount);
            }, 0);
        }

        function getTodayDateKey() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function calculateClosingBalanceToday() {
            const todayKey = getTodayDateKey();
            const transactionsUpToToday = appState.transactions.filter(t => t.type !== 'closing' && t.date <= todayKey);
            return transactionsUpToToday.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
        }

        function calculateWeeklyStats() {
            const range = getWeekRangeFromTuesday();

            const weeklyTransactions = appState.transactions.filter(t => {
                const d = new Date(t.date);
                return d >= range.start && d < range.end;
            });

            const income = weeklyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const expenses = weeklyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            return {
                income,
                expenses,
                balance: income - expenses,
                range
            };
        }

        function updateBudgetCompass() {
            computeWeeklyBudgetSpending();
            const totalBudget = appState.budgets.filter(b => b.active).reduce((sum, b) => sum + b.amount, 0);
            const totalSpent = appState.budgets.filter(b => b.active).reduce((sum, b) => sum + b.spent, 0);
            const percentage = totalBudget > 0 ? Math.round((totalSpent / totalBudget) * 100) : 0;

            document.getElementById('budgetPercentage').textContent = `${percentage}%`;
            document.getElementById('weeklyBudget').textContent = `${formatCurrency(totalSpent)} / ${formatCurrency(totalBudget)}`;
            
            // Update progress circle
            const circle = document.getElementById('budgetProgressCircle');
            const circumference = 2 * Math.PI * 50; // radius = 50
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Update color based on percentage
            if (percentage >= 100) {
                circle.style.stroke = 'var(--color-danger)';
            } else if (percentage >= 75) {
                circle.style.stroke = 'var(--color-warning)';
            } else {
                circle.style.stroke = 'var(--color-primary)';
            }
        }

        function renderBalanceSparkline() {
            const svg = document.getElementById('balanceSparkline');
            svg.innerHTML = '';
            
            // Generate 7 days of balance data
            const days = 7;
            const data = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                const dayTransactions = appState.transactions.filter(t => 
                    new Date(t.date).toDateString() === date.toDateString()
                );
                
                const dayBalance = dayTransactions.reduce((sum, t) => 
                    sum + (t.type === 'income' ? t.amount : -t.amount), 0
                );
                
                data.push(dayBalance);
            }
            
            if (data.length === 0) return;
            
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            
            // Draw line
            const points = data.map((value, i) => {
                const x = (i / (data.length - 1)) * 280 + 10;
                const y = 50 - ((value - min) / range) * 40;
                return `${x},${y}`;
            }).join(' ');
            
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', points);
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', 'var(--color-primary)');
            polyline.setAttribute('stroke-width', '2');
            polyline.setAttribute('stroke-linecap', 'round');
            polyline.setAttribute('stroke-linejoin', 'round');
            
            svg.appendChild(polyline);
            
            // Add points
            data.forEach((value, i) => {
                const x = (i / (data.length - 1)) * 280 + 10;
                const y = 50 - ((value - min) / range) * 40;
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '2');
                circle.setAttribute('fill', 'var(--color-primary)');
                circle.classList.add('sparkline-point');
                
                svg.appendChild(circle);
            });
        }

        function renderRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            const recent = appState.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            container.innerHTML = recent.map(t => {
                const category = appState.categories.find(c => c.id === t.category);
                return `
                    <div class="flex items-center justify-between py-3 border-b border-border last:border-b-0">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm" style="background: ${category?.color}20;">
                                ${category?.icon || '💰'}
                            </div>
                            <div>
                                <div class="font-medium text-textPrimary text-sm">${t.merchant}</div>
                                <div class="text-xs text-textSecondary">${formatDate(t.date)} • ${category?.name || 'Other'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'}">
                                ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-textSecondary">
                        <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
                        <p>No transactions yet</p>
                        <p class="text-sm">Add your first transaction using the + button</p>
                    </div>
                `;
            }
        }

        function renderTransactions() {
            if (appState.loadingTransactions) {
                renderTransactionsSkeleton();
                renderTransactionCardsSkeleton();
                return;
            }
            renderTransactionsTable();
            renderTransactionCards();
            updateSortIndicators();
        }

        function renderTransactionsTable() {
    const tbody = document.getElementById('transactionsTableBody');
    tbody.className = ''; // Clears classes like 'divide-y divide-transparent'

    const transactions = getFilteredTransactions();
    const nonClosingTransactions = transactions.filter(t => t.type !== 'closing');
    let nonClosingRowIndex = 0; 

    tbody.innerHTML = transactions.map((t) => {
        const category = appState.categories.find(c => c.id === t.category);
        const isClosing = t.type === 'closing';
        const isSelected = !isClosing && appState.selectedTransactions.has(t.id);

        if (isClosing) {
            const collapsed = appState.collapsedDays[t.date];
            return `
                <tr data-id="${t.id}" data-date="${t.date}" class="closing-entry-row ${collapsed ? 'collapsed' : ''}">
                    <td colspan="2" class="px-4 py-3 text-left text-sm closing-data-emphasis closing-date">
                        <button class="w-full flex items-center justify-between" onclick="toggleDayCollapse('${t.date}')">
                            <span>${formatSpecialDateDisplay(t.date)}</span>
                            <i class="fas fa-chevron-${collapsed ? 'right' : 'down'} ml-2"></i>
                        </button>
                    </td>
                    <td class="px-4 py-3"></td>
                    <td class="px-4 py-3"></td>
                    <td class="px-4 py-3 text-right font-mono tabular-nums text-base closing-data-emphasis">
                        ${formatCurrency(t.amount)}
                    </td>
                    <td class="px-4 py-3"></td>
                </tr>
            `;
        } else {
            if (appState.collapsedDays[t.date]) {
                return '';
            }
            let rowClasses = "transactions-row group";
            if (t.type === 'income') {
                rowClasses += " row-income";
            } else if (t.type === 'expense') {
                rowClasses += " row-expense";
            }
            if (isSelected) {
                rowClasses += " bg-selected-row";
            } else {
                // Base for rows is surface2 (from table container). Apply bg-surface1-alt for odd rows.
                // nonClosingRowIndex is 0-indexed.
                // If nonClosingRowIndex is 0 (first non-closing, visually "even" if surface2 is base), it gets no class.
                // If nonClosingRowIndex is 1 (second non-closing, visually "odd"), it gets bg-surface1-alt.
                if (nonClosingRowIndex % 2 !== 0) { 
                    rowClasses += " bg-surface1-alt";
                }
            }
            nonClosingRowIndex++; 

            return `
                <tr data-id="${t.id}" class="${rowClasses}">
                    <td class="px-3 py-4 text-center">
                        <input type="checkbox" class="transaction-checkbox focus-ring rounded border-border opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity" data-id="${t.id}" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td class="px-4 py-4 text-xs font-mono text-textSecondary text-center">
                        ${formatDate(t.date)}
                    </td>
                    <td class="px-4 py-4 font-semibold text-textPrimary merchant-col">
                        ${t.merchant}
                    </td>
                    <td class="px-4 py-4">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" style="background:${category?.color}26;color:${category?.color}">
                            ${category?.icon || '💰'} <span class="ml-1">${category?.name || 'Other'}</span>
                        </span>
                    </td>
                    <td class="px-4 py-4 text-right font-mono tabular-nums text-base font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex items-center space-x-2 row-chrome opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity">
                            <button onclick="editTransaction(${t.id})" aria-label="Edit" class="focus-ring p-2 rounded-md text-primary hover:bg-surface3 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaction(${t.id})" aria-label="Delete" class="focus-ring p-2 rounded-md text-danger hover:bg-surface3 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }).join('');

    tbody.querySelectorAll('.transaction-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const id = parseInt(e.target.dataset.id);
            if (e.target.checked) {
                appState.selectedTransactions.add(id);
            } else {
                appState.selectedTransactions.delete(id);
            }
            updateBulkActions();

            const row = checkbox.closest('tr');
            if (row) {
                row.classList.remove('bg-selected-row', 'bg-surface1-alt');
                
                if (e.target.checked) {
                    row.classList.add('bg-selected-row');
                } else {
                    const allRowsInTable = Array.from(tbody.children);
                    const currentNonClosingRows = allRowsInTable.filter(r => !r.classList.contains('closing-entry-row'));
                    const rowIndexAmongNonClosing = currentNonClosingRows.indexOf(row);

                    if (rowIndexAmongNonClosing !== -1 && rowIndexAmongNonClosing % 2 !== 0) {
                        row.classList.add('bg-surface1-alt');
                    }
                }
            }
        });
    });

    if (transactions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center text-textSecondary">
                    <i class="fas fa-search text-3xl mb-2 opacity-50"></i>
                    <p>No transactions found</p>
                    <p class="text-sm">Try adjusting your search or filters</p>
                </td>
            </tr>
        `;
    }
}

        function renderTransactionsSkeleton() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = Array.from({length:4}).map(() => `
                <tr>
                    <td class="px-4 py-3" colspan="6">
                        <div class="h-4 skeleton"></div>
                    </td>
                </tr>
            `).join('');
        }

        function renderTransactionCards() {
            const container = document.getElementById('transactionCards');
            const transactions = getFilteredTransactions();
            
            container.innerHTML = transactions.map(t => {
                const category = appState.categories.find(c => c.id === t.category);
                const isSelected = appState.selectedTransactions.has(t.id);
                const isClosing = t.type === 'closing';

                if (isClosing) {
                    const collapsed = appState.collapsedDays[t.date];
                    return `
                        <div class="transaction-card closing-entry-card rounded-lg p-4 shadow-md relative" data-date="${t.date}">
                            <div class="flex justify-between items-center">
                                <button class="closing-card-date text-sm truncate flex items-center" onclick="toggleDayCollapse('${t.date}')">
                                    <span>${formatSpecialDateDisplay(t.date)}</span>
                                    <i class="fas fa-chevron-${collapsed ? 'right' : 'down'} ml-2"></i>
                                </button>
                                <div class="closing-card-amount font-mono text-base">${formatCurrency(t.amount)}</div>
                            </div>
                            <div class="mt-1 text-xs text-textSecondary text-right">
                                Closing Balance
                            </div>
                        </div>
                    `;
                }

                if (appState.collapsedDays[t.date]) {
                    return '';
                }

                return `
                    <div class="transaction-card bg-surface2 rounded-lg p-4 shadow-md relative ${isSelected ? 'ring-2 ring-primary' : ''} group" data-id="${t.id}">
                        <div class="flex justify-between items-center">
                            <div class="font-medium text-textPrimary truncate">${t.merchant}</div>
                            <div class="font-mono text-base font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'}">
                                ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                            </div>
                        </div>
                        <div class="mt-1 flex items-center justify-between text-sm">
                            <span class="font-mono text-textSecondary">${formatDate(t.date)}</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" style="background:${category?.color}26;color:${category?.color}">
                                ${category?.icon || '💰'} <span class="ml-1">${category?.name || 'Other'}</span>
                            </span>
                            <div class="relative">
                                <button class="ml-2 text-textSecondary hover:text-textPrimary transition-colors opacity-0 group-hover:opacity-100" onclick="toggleTransactionMenu(${t.id})">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="menu-${t.id}" class="hidden absolute right-0 top-6 bg-surface1 rounded-lg shadow-lg border border-border py-1 z-10 min-w-32">
                                    <button onclick="editTransaction(${t.id})" class="w-full text-left px-3 py-2 text-sm text-textPrimary hover:bg-surface2 transition-colors">
                                        <i class="fas fa-edit mr-2"></i>Edit
                                    </button>
                                    <button onclick="deleteTransaction(${t.id})" class="w-full text-left px-3 py-2 text-sm text-danger hover:bg-surface2 transition-colors">
                                        <i class="fas fa-trash mr-2"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${isSelected ? `
                            <div class="absolute top-2 left-2">
                                <div class="w-5 h-5 bg-primary rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs"></i>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Add long press support for mobile
            container.querySelectorAll('.transaction-card:not(.closing-entry-card)').forEach(card => {
                let pressTimer;
                
                card.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        const id = parseInt(card.dataset.id);
                        toggleTransactionSelection(id);
                    }, 500);
                });
                
                card.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
                
                card.addEventListener('touchmove', () => {
                    clearTimeout(pressTimer);
                });
            });
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-textSecondary">
                        <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg">No transactions found</p>
                        <p class="text-sm">Try adjusting your search or filters</p>
                    </div>
                `;
            }
        }

        function renderTransactionCardsSkeleton() {
            const container = document.getElementById('transactionCards');
            container.innerHTML = Array.from({length:3}).map(() => `
                <div class="bg-surface2 rounded-lg p-4 shadow-md space-y-2">
                    <div class="h-4 skeleton w-1/2"></div>
                    <div class="h-3 skeleton w-1/3"></div>
                </div>
            `).join('');
        }


        function formatSpecialDateDisplay(dateString) {
    const entryDate = new Date(dateString); 
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    entryDate.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    yesterday.setHours(0, 0, 0, 0);

    if (entryDate.getTime() === today.getTime()) {
        return "Today";
    }
    if (entryDate.getTime() === yesterday.getTime()) {
        return "Yesterday";
    }
    
    const dateForFormatting = new Date(dateString + 'T00:00:00');

    const dayName = dateForFormatting.toLocaleDateString('en-NZ', { weekday: 'short' });
    const dayOfMonth = dateForFormatting.toLocaleDateString('en-NZ', { day: '2-digit' });
    const monthName = dateForFormatting.toLocaleDateString('en-NZ', { month: 'short' });
    const year = dateForFormatting.toLocaleDateString('en-NZ', { year: 'numeric' });

    return `${dayName} ${dayOfMonth} ${monthName} ${year}`;
}

        function getFilteredTransactions() {
            const localNow = new Date();
            const todayDateKey = `${localNow.getFullYear()}-${String(localNow.getMonth() + 1).padStart(2, '0')}-${String(localNow.getDate()).padStart(2, '0')}`;
            
            const yesterdayDate = new Date(localNow);
            yesterdayDate.setDate(localNow.getDate() - 1);
            const yesterdayDateKey = `${yesterdayDate.getFullYear()}-${String(yesterdayDate.getMonth() + 1).padStart(2, '0')}-${String(yesterdayDate.getDate()).padStart(2, '0')}`;

            const baseTransactions = appState.transactions.filter(t => t.type !== 'closing');
            // Pass todayDateKey to ensure a closing entry for today is considered if needed
            const closingEntries = generateClosingEntries(baseTransactions, todayDateKey); 
            
            let filtered = [...baseTransactions, ...closingEntries]; 
            
            const searchTerm = document.getElementById('transactionSearch')?.value.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(t => {
                    if (t.type === 'closing') return true; // Keep all closing entries for now, date filter will handle
                    return t.merchant.toLowerCase().includes(searchTerm) ||
                           (appState.categories.find(c => c.id === t.category)?.name.toLowerCase().includes(searchTerm));
                });
            }
            
            const activeFilterPill = document.querySelector('#categoryDropdownMenu .filter-pill.active, #categoryDropdownMenuMobile .filter-pill.active');
            const activeCategoryFilter = activeFilterPill?.dataset.filter || 'all';

            if (activeCategoryFilter && activeCategoryFilter !== 'all') {
                filtered = filtered.filter(t => {
                    if (t.type === 'closing') return true; // Keep all closing entries for now
                    if (activeCategoryFilter === 'income' || activeCategoryFilter === 'expense') {
                        return t.type === activeCategoryFilter;
                    } else {
                        return t.category === activeCategoryFilter;
                    }
                });
            }
            
            const activeDateFilterBtn = document.querySelector('#dateDropdownMenu .date-filter-btn[data-range].active, #dateDropdownMenuMobile .date-filter-btn[data-range].active');
            const activeDateFilter = activeDateFilterBtn?.dataset.range || 'all';

            if (activeDateFilter && activeDateFilter !== 'all') {
                let filterStartDate, filterEndDate;
                const nowForFilters = new Date(); // Use a consistent "now" for filter range calculation

                switch (activeDateFilter) {
                    case 'today':
                        filterStartDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth(), nowForFilters.getDate());
                        filterEndDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth(), nowForFilters.getDate(), 23, 59, 59, 999);
                        break;
                    case 'week': 
                        // Week starts on Monday, ends on Sunday
                        const currentDayOfWeek = nowForFilters.getDay(); // 0 (Sun) to 6 (Sat)
                        const diffToMonday = currentDayOfWeek === 0 ? -6 : 1 - currentDayOfWeek; // days to go back to reach Monday
                        filterStartDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth(), nowForFilters.getDate() + diffToMonday);
                        filterStartDate.setHours(0,0,0,0);

                        filterEndDate = new Date(filterStartDate);
                        filterEndDate.setDate(filterStartDate.getDate() + 6); // Sunday
                        filterEndDate.setHours(23,59,59,999);
                        break;
                    case 'month': 
                        filterStartDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth(), 1);
                        filterEndDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth() + 1, 0, 23, 59, 59, 999); 
                        break;
                    case 'lastMonth':
                        filterStartDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth() - 1, 1);
                        filterEndDate = new Date(nowForFilters.getFullYear(), nowForFilters.getMonth(), 0, 23, 59, 59, 999); 
                        break;
                }

                if (filterStartDate && filterEndDate) {
                    filtered = filtered.filter(t => {
                        // t.date is YYYY-MM-DD string. Convert to local Date object at midnight.
                        const itemDate = new Date(t.date + "T00:00:00");

                        if (t.type === 'closing') {
                            if (activeDateFilter === 'today') {
                                // For "Today" filter, include closing for actual today AND actual yesterday
                                return t.date === todayDateKey || t.date === yesterdayDateKey;
                            }
                            // For other ranges, include if the closing entry's date is within the range.
                            // A closing entry for date D is end of day D.
                            return itemDate >= filterStartDate && itemDate <= filterEndDate;
                        } else { // Regular transaction
                            return itemDate >= filterStartDate && itemDate <= filterEndDate;
                        }
                    });
                }
            }
            
            // Sorting (ensure this handles YYYY-MM-DD strings correctly for dates)
            return filtered.sort((a, b) => {
                if (appState.sortField === 'date') {
                    // Dates are YYYY-MM-DD strings, direct string comparison works for sorting
                    const dateAStr = a.date;
                    const dateBStr = b.date;

                    if (appState.sortDirection === 'desc') { // Newest first
                        if (dateAStr > dateBStr) return -1;
                        if (dateAStr < dateBStr) return 1;
                        // Dates are same, sort by type (closing first) then by ID for stability
                        if (a.type === 'closing' && b.type !== 'closing') return -1;
                        if (a.type !== 'closing' && b.type === 'closing') return 1;
                        return b.id && a.id ? (String(b.id).localeCompare(String(a.id))) : 0; 
                    } else { // Oldest first (asc)
                        if (dateAStr < dateBStr) return -1;
                        if (dateAStr > dateBStr) return 1;
                        // Dates are same, sort by type (transactions first, then closing) then by ID
                        if (a.type !== 'closing' && b.type === 'closing') return -1;
                        if (a.type === 'closing' && b.type !== 'closing') return 1;
                        return a.id && b.id ? (String(a.id).localeCompare(String(b.id))) : 0;
                    }
                }

                // For other fields (merchant, amount)
                let valA = a[appState.sortField];
                let valB = b[appState.sortField];
                
                if (typeof valA === 'string' && typeof valB === 'string' && (a.type !== 'closing' && b.type !== 'closing')) { // Avoid lowercasing closing entry 'merchant' (empty)
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                // Ensure closing entries don't interfere with merchant/amount sort if they have null/empty values
                if (a.type === 'closing') valA = appState.sortDirection === 'asc' ? Infinity : -Infinity; // Push to end/start
                if (b.type === 'closing') valB = appState.sortDirection === 'asc' ? Infinity : -Infinity;


                if (valA < valB) return appState.sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return appState.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Also, ensure generateClosingEntries is robust:
        function generateClosingEntries(transactions, todayDateKey) { // todayDateKey is YYYY-MM-DD
            const nonClosing = transactions.filter(t => t.type !== 'closing');
            const closings = [];

            if (nonClosing.length === 0) {
                if (todayDateKey) {
                    closings.push({
                        id: `closing-${todayDateKey}`,
                        type: 'closing',
                        date: todayDateKey,
                        merchant: '',
                        category: 'closing',
                        amount: 0
                    });
                }
                return closings;
            }

            const sorted = [...nonClosing].sort((a, b) => a.date.localeCompare(b.date));

            let balance = 0;
            let lastDate = null;

            sorted.forEach(tr => {
                balance += tr.type === 'income' ? tr.amount : -tr.amount;

                if (tr.date === lastDate) {
                    // Update closing for same day
                    closings[closings.length - 1].amount = balance;
                } else {
                    closings.push({
                        id: `closing-${tr.date}`,
                        type: 'closing',
                        date: tr.date,
                        merchant: '',
                        category: 'closing',
                        amount: balance
                    });
                    lastDate = tr.date;
                }
            });

            if (todayDateKey) {
                const lastTransactionDateKey = sorted[sorted.length - 1].date;
                if (todayDateKey > lastTransactionDateKey) {
                    closings.push({
                        id: `closing-${todayDateKey}`,
                        type: 'closing',
                        date: todayDateKey,
                        merchant: '',
                        category: 'closing',
                        amount: balance
                    });
                }
            }

            return closings;
        }

        function filterTransactions() {
            renderTransactions();
        }

        function updateCategoryDropdownLabel() {
            const activeDesktop = document.querySelector('#categoryDropdownMenu .filter-pill.active');
            const activeMobile = document.querySelector('#categoryDropdownMenuMobile .filter-pill.active');
            const active = activeDesktop || activeMobile;
            
            const label = active ? active.textContent.trim() : 'Category';
            const isFiltered = active && active.dataset.filter !== 'all';
            
            const desktopBtn = document.getElementById('categoryDropdownBtn');
            const mobileBtn = document.getElementById('categoryDropdownBtnMobile');

            if (desktopBtn) {
                desktopBtn.textContent = `${label} ▾`;
                desktopBtn.classList.toggle('active', isFiltered);
            }
            if (mobileBtn) {
                mobileBtn.textContent = `${label} ▾`;
                mobileBtn.classList.toggle('active', isFiltered);
            }
        }

        function updateDateDropdownLabel() {
            const activeDesktop = document.querySelector('#dateDropdownMenu .date-filter-btn[data-range].active');
            const activeMobile = document.querySelector('#dateDropdownMenuMobile .date-filter-btn[data-range].active');
            const active = activeDesktop || activeMobile;

            const label = active ? active.textContent.trim() : 'Date Range';
            const isFiltered = active && active.dataset.range !== 'all';

            const desktopBtn = document.getElementById('dateDropdownBtn');
            const mobileBtn = document.getElementById('dateDropdownBtnMobile');

            if (desktopBtn) {
                desktopBtn.textContent = `${label} ▾`;
                desktopBtn.classList.toggle('active', isFiltered);
            }
            if (mobileBtn) {
                mobileBtn.textContent = `${label} ▾`;
                mobileBtn.classList.toggle('active', isFiltered);
            }
        }

        function updateSortIndicators() {
            document.querySelectorAll('[data-sort]').forEach(th => {
                const field = th.dataset.sort;
                const dir = field === appState.sortField ? appState.sortDirection : 'none';
                th.setAttribute('aria-sort', dir === 'none' ? 'none' : dir === 'asc' ? 'ascending' : 'descending');
                const icon = th.querySelector('i');
                if (icon) {
                    icon.classList.toggle('rotate-180', dir === 'asc');
                    icon.classList.toggle('opacity-0', dir === 'none');
                }
            });
        }

        function setSort(field) {
            if (appState.sortField === field) {
                appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                appState.sortField = field;
                // Default sort direction for new fields:
                // Date: desc (newest first)
                // Merchant: asc (A-Z)
                // Amount: desc (largest first)
                appState.sortDirection = (field === 'merchant') ? 'asc' : 'desc';
            }
            renderTransactions();
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAllTransactions').checked;
            const visibleTransactions = getFilteredTransactions().filter(t => t.type !== 'closing'); // Only select non-closing
            
            if (isChecked) {
                visibleTransactions.forEach(t => appState.selectedTransactions.add(t.id));
            } else {
                // If unchecking selectAll, clear all selected, even those not visible (safer)
                // appState.selectedTransactions.clear(); 
                // Or only clear visible ones:
                visibleTransactions.forEach(t => appState.selectedTransactions.delete(t.id));
            }
            
            updateBulkActions();
            renderTransactionsTable(); // Only re-render table for checkbox state updates
            renderTransactionCards(); // Re-render cards for selection state updates
        }

        function updateBulkActions() {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCount = appState.selectedTransactions.size;
            
            if (selectedCount > 0) {
                bulkDeleteBtn.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                bulkDeleteBtn.textContent = `Delete Selected (${selectedCount})`;
            } else {
                bulkDeleteBtn.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => bulkDeleteBtn.classList.add('hidden'), 200);
            }
        }

        function toggleTransactionSelection(id) {
            if (appState.selectedTransactions.has(id)) {
                appState.selectedTransactions.delete(id);
            } else {
                appState.selectedTransactions.add(id);
            }
            updateBulkActions();
            renderTransactionCards(); // Re-render cards to show selection state
            // Update specific row checkbox in table if visible
            const checkboxInTable = document.querySelector(`#transactionsTableBody .transaction-checkbox[data-id="${id}"]`);
            if (checkboxInTable) {
                checkboxInTable.checked = appState.selectedTransactions.has(id);
                // Also update row style
                 const row = checkboxInTable.closest('tr');
                if (row) {
                    row.classList.remove('bg-selected-row', 'bg-surface1-alt');
                    if (appState.selectedTransactions.has(id)) {
                        row.classList.add('bg-selected-row');
                    } else {
                        // Re-apply zebra if needed
                        const tbody = document.getElementById('transactionsTableBody');
                        const allRowsInTable = Array.from(tbody.children);
                        const currentNonClosingRows = allRowsInTable.filter(r => !r.classList.contains('closing-entry-row'));
                        const rowIndexAmongNonClosing = currentNonClosingRows.indexOf(row);
                        if (rowIndexAmongNonClosing !== -1 && rowIndexAmongNonClosing % 2 !== 0) {
                            row.classList.add('bg-surface1-alt');
                        }
                    }
                }
            }
        }

        function toggleTransactionMenu(id) {
            // Close all other menus
            document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                if (menu.id !== `menu-${id}`) {
                    menu.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            const menu = document.getElementById(`menu-${id}`);
            menu.classList.toggle('hidden');
            
            // Close menu when clicking outside
            setTimeout(() => {
                const clickOutsideHandler = (e) => {
                    if (menu && !menu.contains(e.target) && !menu.previousElementSibling.contains(e.target)) {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', clickOutsideHandler);
                    }
                };
                document.addEventListener('click', clickOutsideHandler);
            }, 0); // Use 0 timeout to ensure it's added after current event bubble
        }

        function toggleDayCollapse(date) {
            appState.collapsedDays[date] = !appState.collapsedDays[date];
            renderTransactions();
        }

        function renderBudgets() {
            computeWeeklyBudgetSpending();
            renderBudgetCards();
        }

        function renderBudgetCards() {
            const pinnedContainer = document.getElementById('pinnedBudgetCards');
            const allContainer = document.getElementById('budgetCards');
            
            const pinnedBudgets = appState.budgets.filter(b => b.pinned && b.active);
            const otherBudgets = appState.budgets.filter(b => (!b.pinned || !b.active) && b.active);
            
            // Render pinned budgets
            pinnedContainer.innerHTML = pinnedBudgets.map(renderBudgetCard).join('');
            
            // Render other budgets
            allContainer.innerHTML = otherBudgets.map(renderBudgetCard).join('');
            
            // Hide pinned section if empty
            const pinnedSection = document.getElementById('pinnedBudgets');
            pinnedSection.style.display = pinnedBudgets.length > 0 ? 'block' : 'none';
        }

        function renderBudgetCard(budget) {
  const category = appState.categories.find(c => c.id === budget.id) || {};
  const spent = budget.spent || 0;
  const realAmount = budget.amount; 
  const percentage = realAmount > 0 ? Math.round((spent / realAmount) * 100) : 0;
  const remaining = realAmount - spent;

  let headerClass = 'bg-gray-500'; // Default, consider var(--color-surface-4) or similar
  let progressBarClass = 'bg-green-500'; // Consider var(--color-primary) or success color
  
  // Theme adjustments for header/progress bar colors
  const isDark = document.documentElement.classList.contains('dark');
  if (percentage >= 100) {
    headerClass = 'bg-danger'; // Use Tailwind class for var(--color-danger)
    progressBarClass = 'bg-danger';
  } else if (percentage >= 75) {
    headerClass = 'bg-warning'; // Use Tailwind class for var(--color-warning)
    progressBarClass = 'bg-warning';
  } else {
    headerClass = 'bg-primary'; // Use Tailwind class for var(--color-primary)
    progressBarClass = 'bg-primary'; // Or a success color if primary is not green-ish
  }


  const sliderPosition = Math.round(realAmount / 5);

  return `
    <div class="budget-card bg-surface2 rounded-lg shadow-md overflow-hidden" id="budget-card-${budget.id}">
      <div class="p-4 ${headerClass} text-white" id="budget-header-${budget.id}">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="text-xl">${category.icon || '💰'}</span>
            <span class="font-semibold">${category.name || 'Other'}</span>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="toggleBudgetPin('${budget.id}')" class="text-white/80 hover:text-white transition-colors">
              <i class="fas ${budget.pinned ? 'fa-star' : 'fa-star-o'}"></i>
            </button>
            <button onclick="toggleBudgetPause('${budget.id}')" class="text-white/80 hover:text-white transition-colors">
              <i class="fas ${budget.active ? 'fa-pause' : 'fa-play'}"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="p-4">
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-textSecondary">Budget</span>
            <span class="text-sm font-medium text-textPrimary" id="budget-amount-display-${budget.id}">
              ${formatCurrency(realAmount)}
            </span>
          </div>
          <input
            type="range"
            id="budget-slider-${budget.id}"
            class="w-full budget-slider"
            data-id="${budget.id}"
            min="0"
            max="1000"            
            step="1"              
            value="${sliderPosition}"
            oninput="liveUpdateBudgetAmount('${budget.id}', this.value)"
            onchange="updateBudgetAmount('${budget.id}', this.value)"
          >
        </div>
        
        <div class="mb-4">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm text-textSecondary">Progress</span>
            <span class="text-sm font-medium text-textPrimary" id="budget-percentage-display-${budget.id}">
              ${percentage}%
            </span>
          </div>
          <div class="w-full bg-surface3 rounded-full h-2">
            <div
              id="budget-progress-bar-${budget.id}"
              class="h-2 rounded-full transition-all duration-300 ${progressBarClass}"
              style="width: ${Math.min(percentage, 100)}%;"
            ></div>
          </div>
        </div>
        
        <div class="flex items-center justify-between text-sm">
          <span class="text-textSecondary" id="budget-remaining-display-${budget.id}">
            ${remaining >= 0
              ? `${formatCurrency(remaining)} remaining`
              : `${formatCurrency(Math.abs(remaining))} over`}
          </span>
          <span class="font-medium text-textPrimary" id="budget-spent-display-${budget.id}">
            ${formatCurrency(spent)} spent
          </span>
        </div>
        
        <div class="mt-3 h-8 bg-surface3 rounded opacity-50 flex items-center justify-center">
          <span class="text-xs text-textSecondary">30-day trend</span>
        </div>
      </div>
    </div>
  `;
}

  function liveUpdateBudgetAmount(budgetId, sliderValueStr) {
  const sliderValue = parseInt(sliderValueStr, 10); 
  const realAmount = sliderValue * 5;              

  const budget = appState.budgets.find(b => b.id === budgetId);
  if (!budget) return;
  budget.amount = realAmount; 

  const spent = budget.spent || 0;
  const percentage = realAmount > 0 ? Math.round((spent / realAmount) * 100) : 0;
  const remaining = realAmount - spent;

  let headerClass = 'bg-primary';
  let progressBarClass = 'bg-primary';
  if (percentage >= 100) {
    headerClass = 'bg-danger';
    progressBarClass = 'bg-danger';
  } else if (percentage >= 75) {
    headerClass = 'bg-warning';
    progressBarClass = 'bg-warning';
  }


  const amountSpan = document.getElementById(`budget-amount-display-${budgetId}`);
  if (amountSpan) {
    amountSpan.textContent = formatCurrency(realAmount);
  }

  const percentSpan = document.getElementById(`budget-percentage-display-${budgetId}`);
  if (percentSpan) {
    percentSpan.textContent = `${percentage}%`;
  }

  const progressBar = document.getElementById(`budget-progress-bar-${budgetId}`);
  if (progressBar) {
    const widthPercent = Math.min(percentage, 100);
    progressBar.style.width = `${widthPercent}%`;
    progressBar.className = `h-2 rounded-full transition-all duration-300 ${progressBarClass}`; // Reset and apply new class
  }

  const remainingSpan = document.getElementById(`budget-remaining-display-${budgetId}`);
  if (remainingSpan) {
    if (remaining >= 0) {
      remainingSpan.textContent = `${formatCurrency(remaining)} remaining`;
    } else {
      remainingSpan.textContent = `${formatCurrency(Math.abs(remaining))} over`;
    }
  }

  const headerDiv = document.getElementById(`budget-header-${budgetId}`);
  if (headerDiv) {
    headerDiv.className = `p-4 ${headerClass} text-white`; // Reset and apply new class
  }

  saveData();

  if (appState.currentPage === 'dashboard') {
    updateBudgetCompass();
  }
}

function updateBudgetAmount(budgetId, sliderValueStr) {
  liveUpdateBudgetAmount(budgetId, sliderValueStr);
}


        function toggleBudgetPin(budgetId) {
            const budget = appState.budgets.find(b => b.id === budgetId);
            if (budget) {
                budget.pinned = !budget.pinned;
                saveData();
                renderBudgets();
            }
        }

        function toggleBudgetPause(budgetId) {
            const budget = appState.budgets.find(b => b.id === budgetId);
            if (budget) {
                budget.active = !budget.active;
                saveData();
                renderBudgets();
                if (appState.currentPage === 'dashboard') {
                    updateBudgetCompass();
                }
            }
        }

        function renderReports() {
            renderSpendingChart();
            renderTrendsChart();
            renderVarianceTable();
        }

        function renderSpendingChart() {
            const canvas = document.getElementById('spendingChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous chart
            
            const expenses = appState.transactions.filter(t => t.type === 'expense');
            const categoryTotals = {};
            
            expenses.forEach(t => {
                if (!categoryTotals[t.category]) {
                    categoryTotals[t.category] = 0;
                }
                categoryTotals[t.category] += t.amount;
            });
            
            const categories = Object.keys(categoryTotals);
            const values = Object.values(categoryTotals);
            const total = values.reduce((sum, v) => sum + v, 0);
            
            if (total === 0) {
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-secondary').trim();
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.8; // Adjust radius
            
            let currentAngle = -0.5 * Math.PI; // Start at the top
            
            categories.forEach((category, i) => {
                const categoryInfo = appState.categories.find(c => c.id === category);
                const sliceAngle = (values[i] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                
                ctx.fillStyle = categoryInfo?.color || '#747D8C';
                ctx.fill();
                
                currentAngle += sliceAngle;
            });
        }

        function renderTrendsChart() {
            const canvas = document.getElementById('trendsChart');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(date.toLocaleDateString('en-NZ', { month: 'short' }));
                
                const monthTransactions = appState.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear();
                });
                
                const monthIncome = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const monthExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpenses);
            }
            
            if (incomeData.every(v => v === 0) && expenseData.every(v => v === 0)) {
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-secondary').trim();
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const maxValue = Math.max(1, ...incomeData, ...expenseData); // Ensure maxValue is at least 1 to avoid division by zero
            const chartHeight = canvas.height - 40; // Padding for labels
            const chartWidth = canvas.width - 60; // Padding for labels
            const yAxisOrigin = canvas.height - 20; // Bottom padding
            const xAxisOrigin = 30; // Left padding

            // Draw X-axis labels (months)
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-secondary').trim();
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            months.forEach((month, i) => {
                const x = xAxisOrigin + (i / (months.length - 1)) * chartWidth;
                ctx.fillText(month, x, canvas.height - 5);
            });
            
            // Draw Y-axis (simple line for now)
            ctx.beginPath();
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--color-border').trim();
            ctx.moveTo(xAxisOrigin, 20);
            ctx.lineTo(xAxisOrigin, yAxisOrigin);
            ctx.stroke();


            // Draw income line (green)
            ctx.beginPath();
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--color-primary').trim(); // Use primary color
            ctx.lineWidth = 2;
            incomeData.forEach((value, i) => {
                const x = xAxisOrigin + (i / (incomeData.length - 1)) * chartWidth;
                const y = yAxisOrigin - (value / maxValue) * chartHeight;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw expense line (red)
            ctx.beginPath();
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--color-danger').trim();
            ctx.lineWidth = 2;
            expenseData.forEach((value, i) => {
                const x = xAxisOrigin + (i / (expenseData.length - 1)) * chartWidth;
                const y = yAxisOrigin - (value / maxValue) * chartHeight;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        }

       function renderVarianceTable() {
            computeWeeklyBudgetSpending();
            const tbody = document.getElementById('varianceTableBody');
            
            tbody.innerHTML = appState.budgets.filter(b => b.active).map(budget => {
                const category = appState.categories.find(c => c.id === budget.id);
                const variance = budget.spent - budget.amount; // Positive if overspent, negative if underspent
                const variancePercent = budget.amount > 0 ? ((variance / budget.amount) * 100).toFixed(1) : (budget.spent > 0 ? '∞' : '0');
                
                let varianceColorClass = 'text-income'; // Underspent or on budget
                if (variance > 0) varianceColorClass = 'text-expense'; // Overspent
                else if (variance === 0 && budget.amount === 0 && budget.spent > 0) varianceColorClass = 'text-expense'; // Spent with no budget
                else if (variance === 0) varianceColorClass = 'text-textSecondary'; // Exactly on budget or zero spent/budgeted

                return `
                    <tr class="border-b border-border">
                        <td class="py-3 text-sm text-textPrimary">
                            <div class="flex items-center">
                                <span class="mr-2">${category?.icon || '💰'}</span>
                                ${category?.name || 'Other'}
                            </div>
                        </td>
                        <td class="py-3 text-sm text-textPrimary text-right">${formatCurrency(budget.amount)}</td>
                        <td class="py-3 text-sm text-textPrimary text-right">${formatCurrency(budget.spent)}</td>
                        <td class="py-3 text-sm text-right">
                            <span class="${varianceColorClass}">
                                ${variance >= 0 ? '+' : ''}${formatCurrency(variance)}
                                <span class="text-xs opacity-75">(${variancePercent}%)</span>
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderSettings() {
            // Update form values
            document.getElementById('currencySelect').value = appState.settings.currency;
            document.getElementById('dateFormatSelect').value = appState.settings.dateFormat;
            document.getElementById('themeSelect').value = appState.settings.theme;
            document.getElementById('densitySelect').value = appState.settings.density;

            renderCategoriesList();
        }

        function renderCategoriesList() {
            const container = document.getElementById('categoriesList');
            
            container.innerHTML = appState.categories.map(category => `
                <div class="flex items-center justify-between p-3 bg-surface1 rounded-md">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm" style="background: ${category.color}; color: white;">
                            ${category.icon}
                        </div>
                        <span class="font-medium text-textPrimary">${category.name}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="p-2 text-textSecondary hover:text-textPrimary transition-colors" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="p-2 text-danger hover:text-danger/80 transition-colors" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // FAB Functions
        function toggleFab() {
            const fab = document.getElementById('mainFab');
            const fabOptions = document.getElementById('fabOptions');
            const icon = fab.querySelector('i');
            
            appState.fabExpanded = !appState.fabExpanded;
            
            if (appState.fabExpanded) {
                icon.classList.add('fab-expanded');
                fabOptions.classList.remove('opacity-0', 'scale-0');
                fabOptions.classList.add('opacity-100', 'scale-100', 'show');
            } else {
                icon.classList.remove('fab-expanded');
                fabOptions.classList.add('opacity-0', 'scale-0');
                fabOptions.classList.remove('opacity-100', 'scale-100', 'show');
            }
        }

        // Transaction Functions
        function openTransactionModal(type = 'expense') {
            const modal = document.getElementById('transactionModal');
            const form = document.getElementById('transactionForm');
            const title = document.getElementById('transactionModalTitle');
            
            // Reset form
            form.reset();
            appState.editingTransaction = null;
            
            // Set type
            document.querySelector(`input[name="type"][value="${type}"]`).checked = true;
            
            // Set today's date
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Update title
            title.textContent = type === 'income' ? 'Add Income' : 'Add Expense';
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Focus first input
            setTimeout(() => {
                document.getElementById('transactionMerchant').focus();
            }, 100);
            
            // Close FAB if expanded
            if (appState.fabExpanded) {
                toggleFab();
            }
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transactionModal');
            modal.classList.add('hidden');
            appState.editingTransaction = null;
        }

        function editTransaction(id) {
            const transaction = appState.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            appState.editingTransaction = transaction;
            
            const modal = document.getElementById('transactionModal');
            const form = document.getElementById('transactionForm');
            const title = document.getElementById('transactionModalTitle');
            
            // Populate form
            document.querySelector(`input[name="type"][value="${transaction.type}"]`).checked = true;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionMerchant').value = transaction.merchant;
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionAmount').value = transaction.amount;
            
            // Update title
            title.textContent = 'Edit Transaction';
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Focus merchant input
            setTimeout(() => {
                document.getElementById('transactionMerchant').focus();
            }, 100);
        }

        function saveTransaction(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
        const transactionData = {
            type: formData.get('type'),
            date: document.getElementById('transactionDate').value,
            merchant: document.getElementById('transactionMerchant').value,
            category: document.getElementById('transactionCategory').value,
            amount: parseFloat(document.getElementById('transactionAmount').value)
        };

        let newTransaction = null;
            
            // Validation
            if (!transactionData.merchant || !transactionData.category || !transactionData.amount || transactionData.amount <= 0) {
                showToast('Please fill in all fields with valid values', 'error');
                return;
            }
            
            if (appState.editingTransaction) {
                // Update existing transaction
                const index = appState.transactions.findIndex(t => t.id === appState.editingTransaction.id);
                if (index !== -1) {
                    const original = appState.transactions[index];

                    // Revert budget spending for the original transaction
                    if (original.type === 'expense') {
                        adjustBudgetSpending(original.category, -original.amount);
                    }

                    // Update transaction in state
                    appState.transactions[index] = { ...original, ...transactionData };

                    const updated = appState.transactions[index];

                    // Apply budget spending for the updated transaction
                    if (updated.type === 'expense') {
                        adjustBudgetSpending(updated.category, updated.amount);
                    }

                    showToast('Transaction updated successfully', 'success');
                }
            } else {
                // Add new transaction
                newTransaction = {
                    id: Date.now() + Math.random(),
                    ...transactionData
                };
                appState.transactions.push(newTransaction);
                showToast('Transaction added successfully', 'success');
                
                // Update budget spending
                updateBudgetSpending(transactionData.category, transactionData.amount, transactionData.type);
            }
            
            saveData();
            closeTransactionModal();
            renderCurrentPage();

            if (!appState.editingTransaction) {
                requestAnimationFrame(() => {
                    const row = document.querySelector(`#transactionsTableBody tr[data-id="${newTransaction?.id}"]`);
                    const card = document.querySelector(`#transactionCards .transaction-card[data-id="${newTransaction?.id}"]`);
                    if (row) {
                        row.style.setProperty('--h', `${row.offsetHeight}px`);
                        row.classList.add('animate-slide-in');
                    }
                    if (card) {
                        card.style.setProperty('--h', `${card.offsetHeight}px`);
                        card.classList.add('animate-slide-in');
                    }
                });
            }
        }

        function updateBudgetSpending(categoryId, amount, type) {
            if (type !== 'expense') return;
            adjustBudgetSpending(categoryId, amount);
        }

        function adjustBudgetSpending(categoryId, delta) {
            let budget = appState.budgets.find(b => b.id === categoryId);
            if (!budget) {
                // Only create a new budget if we are adding spending (delta > 0)
                // If delta is negative (e.g. deleting/editing an expense from a non-budgeted category), do nothing.
                if (delta <= 0 && !appState.categories.find(c => c.id === categoryId)) return;

                budget = {
                    id: categoryId,
                    amount: 0, // Default budget amount
                    spent: 0,
                    pinned: false,
                    active: true
                };
                appState.budgets.push(budget);
            }

            budget.spent += delta;
            if (budget.spent < 0) budget.spent = 0; // Ensure spent doesn't go negative
        }

        function deleteTransaction(id) {
            appState.deletingTransaction = id;
            
            const modal = document.getElementById('deleteModal');
            const text = document.getElementById('deleteModalText');
            
            text.textContent = 'Are you sure you want to delete this transaction? This action cannot be undone.';
            modal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.add('hidden');
            appState.deletingTransaction = null;
        }

        function confirmDelete() {
            if (appState.deletingTransaction) { // Single delete
                const id = appState.deletingTransaction;
                const row = document.querySelector(`#transactionsTableBody tr[data-id="${id}"]`);
                const card = document.querySelector(`#transactionCards .transaction-card[data-id="${id}"]`);

                if (row) {
                    row.style.setProperty('--h', `${row.offsetHeight}px`);
                    row.classList.add('animate-slide-out');
                }
                 if (card) {
                    card.style.setProperty('--h', `${card.offsetHeight}px`);
                    card.classList.add('animate-slide-out');
                }

                setTimeout(() => {
                    const index = appState.transactions.findIndex(t => t.id === id);
                    if (index !== -1) {
                        const transaction = appState.transactions[index];
                        if (transaction.type === 'expense') {
                            adjustBudgetSpending(transaction.category, -transaction.amount);
                        }
                        appState.transactions.splice(index, 1);
                        saveData();
                        renderCurrentPage(); // Re-render after data change
                        showToast('Transaction deleted successfully', 'success');
                    }
                }, 300);
            } else if (appState.selectedTransactions.size > 0) { // Bulk delete
                const selectedIds = Array.from(appState.selectedTransactions);
                
                // Animate removal for visible items
                selectedIds.forEach(id => {
                    const row = document.querySelector(`#transactionsTableBody tr[data-id="${id}"]`);
                    const card = document.querySelector(`#transactionCards .transaction-card[data-id="${id}"]`);
                    if (row) {
                        row.style.setProperty('--h', `${row.offsetHeight}px`);
                        row.classList.add('animate-slide-out');
                    }
                    if (card) {
                        card.style.setProperty('--h', `${card.offsetHeight}px`);
                        card.classList.add('animate-slide-out');
                    }
                });

                setTimeout(() => {
                    appState.transactions = appState.transactions.filter(t => {
                        if (selectedIds.includes(t.id)) {
                            if (t.type === 'expense') {
                                adjustBudgetSpending(t.category, -t.amount);
                            }
                            return false; // Remove from list
                        }
                        return true;
                    });
                    appState.selectedTransactions.clear();
                    saveData();
                    updateBulkActions(); // Hide button
                    renderCurrentPage(); // Re-render after data change
                    showToast(`${selectedIds.length} transactions deleted successfully`, 'success');
                }, 300);
            }
            
            closeDeleteModal();
        }

        // Utility Functions
        function formatCurrency(amount) {
            const formatter = new Intl.NumberFormat('en-NZ', { // Default to en-NZ if currency is not typical
                style: 'currency',
                currency: appState.settings.currency || 'NZD'
            });
            return formatter.format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            // Adjust for timezone offset if dateString is YYYY-MM-DD (interpreted as UTC midnight)
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset);

            const format = appState.settings.dateFormat;
            
            const day = localDate.getDate().toString().padStart(2, '0');
            const month = (localDate.getMonth() + 1).toString().padStart(2, '0');
            const year = localDate.getFullYear();
            
            switch (format) {
                case 'MM/DD/YYYY':
                    return `${month}/${day}/${year}`;
                case 'YYYY-MM-DD':
                    return `${year}-${month}-${day}`;
                default: // DD/MM/YYYY
                    return `${day}/${month}/${year}`;
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-NZ', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const currentDateEl = document.getElementById('currentDate');
            if (currentDateEl) {
                currentDateEl.textContent = dateString;
            }
        }

        function updateCurrencyDisplay() {
            renderCurrentPage();
        }

        function getCurrentWeekRange() {
            const now = new Date();
            const day = now.getDay(); // 0=Sun,1=Mon,2=Tue,...
            // Assuming week starts on Monday for financial tracking
            const diffToMonday = day === 0 ? 6 : day - 1; // days since Monday
            
            const start = new Date(now);
            start.setDate(now.getDate() - diffToMonday);
            start.setHours(0, 0, 0, 0);
            
            const end = new Date(start);
            end.setDate(start.getDate() + 7); // End of Sunday
            return { start, end };
        }

        // Returns the date range starting from this week's Tuesday up to today
        function getWeekRangeFromTuesday() {
            const now = new Date();
            const day = now.getDay(); // 0=Sun,1=Mon,2=Tue...
            const diffToTuesday = (day + 7 - 2) % 7; // days since the most recent Tuesday

            const start = new Date(now);
            start.setDate(now.getDate() - diffToTuesday);
            start.setHours(0, 0, 0, 0);

            const end = new Date(now);
            end.setHours(23, 59, 59, 999);

            return { start, end };
        }

        function updateBalanceDate(range) {
            const options = { month: 'short', day: 'numeric' };
            const startStr = range.start.toLocaleDateString('en-NZ', options);
            const endMinusOneDay = new Date(range.end);
            endMinusOneDay.setDate(range.end.getDate() - 1); // Show up to Sunday
            const endStr = endMinusOneDay.toLocaleDateString('en-NZ', options);

            const el = document.getElementById('balanceDate');
            if (el) {
                el.textContent = `Week: ${startStr} - ${endStr}`;
            }
        }

        function updateBalanceDateToday() {
            const options = { month: 'short', day: 'numeric' };
            const today = new Date();
            const todayStr = today.toLocaleDateString('en-NZ', options);
            const el = document.getElementById('balanceDate');
            if (el) {
                el.textContent = `Today: ${todayStr}`;
            }
        }

        function computeWeeklyBudgetSpending() {
            const range = getWeekRangeFromTuesday();
            appState.budgets.forEach(b => b.spent = 0); // Reset weekly spent for all budgets
            
            appState.transactions.forEach(t => {
                const transactionDate = new Date(t.date);
                // Adjust for timezone if date string is YYYY-MM-DD
                const userTimezoneOffset = transactionDate.getTimezoneOffset() * 60000;
                const localTransactionDate = new Date(transactionDate.getTime() + userTimezoneOffset);

                if (t.type === 'expense' && localTransactionDate >= range.start && localTransactionDate < range.end) {
                    let budget = appState.budgets.find(b => b.id === t.category);
                    if (!budget) {
                        // If category exists in appState.categories but not in budgets, create it
                        if (appState.categories.find(c => c.id === t.category)) {
                             budget = { id: t.category, amount: 0, spent: 0, pinned: false, active: true };
                             appState.budgets.push(budget);
                        } else {
                            // This is an expense for a category not formally defined, skip or handle as 'other'
                            return; 
                        }
                    }
                    if (budget.active) { // Only add to active budgets
                       budget.spent += t.amount;
                    }
                }
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-primary';
            
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 max-w-sm`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Hide toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Data Management Functions
        function downloadBackup() {
            const data = {
                transactions: appState.transactions,
                budgets: appState.budgets,
                settings: appState.settings,
                categories: appState.categories,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `pennypilot-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showToast('Backup downloaded successfully', 'success');
        }

        function uploadBackup(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!data.transactions || !data.budgets || !data.settings) {
                        showToast('Invalid backup file format', 'error');
                        return;
                    }
                    
                    appState.transactions = data.transactions || [];
                    appState.budgets = data.budgets || [];
                    appState.settings = { ...appState.settings, ...(data.settings || {}) };
                    appState.categories = data.categories || appState.categories; // Keep original if not in backup
                    
                    saveData();
                    applyTheme(); // Apply theme from restored settings
                    // Ensure settings UI reflects loaded data
                    document.getElementById('currencySelect').value = appState.settings.currency;
                    document.getElementById('dateFormatSelect').value = appState.settings.dateFormat;
                    document.getElementById('themeSelect').value = appState.settings.theme;

                    renderCurrentPage(); // Full re-render
                    
                    showToast('Backup restored successfully', 'success');
                } catch (error) {
                    console.error("Error restoring backup:", error);
                    showToast('Error reading backup file. Check console for details.', 'error');
                }
            };
            
            reader.readAsText(file);
            e.target.value = ''; 
        }

        function resetData() {
            const modal = document.getElementById('deleteModal');
            const text = document.getElementById('deleteModalText');
            const confirmBtn = document.getElementById('confirmDelete');
            const cancelBtn = document.getElementById('cancelDelete');

            text.textContent = 'Are you sure you want to reset all data? This will permanently delete all transactions, budgets, and settings. This action cannot be undone.';
            
            // Store original handlers or use a flag
            const originalConfirmHandler = confirmBtn.onclick;
            const originalCancelHandler = cancelBtn.onclick;

            const resetHandler = () => {
                localStorage.removeItem('pennyPilot_transactions');
                localStorage.removeItem('pennyPilot_budgets');
                localStorage.removeItem('pennyPilot_settings');

                appState.transactions = [];
                appState.budgets = [];
                appState.settings = {
                    currency: 'NZD',
                    dateFormat: 'DD/MM/YYYY',
                    theme: 'system',
                    density: 'comfy'
                };
                appState.selectedTransactions.clear();
                appState.transactionsLoaded = false; // Force reload effect if needed

                saveData(); // Save the reset state
                applyTheme(); // Apply default theme settings
                applyDensity();

                // Update settings UI to defaults
                document.getElementById('currencySelect').value = appState.settings.currency;
                document.getElementById('dateFormatSelect').value = appState.settings.dateFormat;
                document.getElementById('themeSelect').value = appState.settings.theme;
                document.getElementById('densitySelect').value = appState.settings.density;
                
                closeDeleteModal();
                showPage('dashboard'); // Go to a default page
                renderCurrentPage(); // Re-render with empty data
                showToast('All data has been reset', 'success');

                // Restore original handlers
                confirmBtn.onclick = originalConfirmHandler;
                cancelBtn.onclick = originalCancelHandler;
            };
            
            const cancelResetHandler = () => {
                closeDeleteModal();
                // Restore original handlers
                confirmBtn.onclick = originalConfirmHandler;
                cancelBtn.onclick = originalCancelHandler;
            };

            confirmBtn.onclick = resetHandler;
            cancelBtn.onclick = cancelResetHandler;
            
            modal.classList.remove('hidden');
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (appState.settings.theme === 'system') {
                applyTheme();
            }
        });

        // Add bulk delete event listener
        document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
            if (appState.selectedTransactions.size === 0) return;
            
            // Ensure appState.deletingTransaction is null for bulk delete mode
            appState.deletingTransaction = null; 
            
            const modal = document.getElementById('deleteModal');
            const text = document.getElementById('deleteModalText');
            
            text.textContent = `Are you sure you want to delete ${appState.selectedTransactions.size} selected transactions? This action cannot be undone.`;
            modal.classList.remove('hidden');
        });
    </script>
</body>
</html>
